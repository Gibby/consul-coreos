#!/bin/bash

set -e

this_ip="$1"; shift
this_machine="$1"; shift
consul_args="$@"

etcdctl="docker run --net=host --rm cap10morgan/etcdctl:0.4.6"

${etcdctl} set /consul.io/bootstrap/machines/${this_machine} ${this_ip} > /dev/null

nodes=( $(${etcdctl} ls /consul.io/bootstrap/machines) )
first_node=${nodes[0]}

if [[ -n "${first_node}" ]]; then
  join_ip=$(${etcdctl} get ${first_node})
  join_arg="--join ${join_ip}"
  if [[ "${join_ip}" == "${this_ip}" ]]; then
    join_arg=""
  fi
fi

ip_args="${this_ip}"
if [[ -n "${join_ip}" ]]; then
  ip_args="${ip_args}::${join_ip}"
fi

exec /bin/start --server --advertise ${this_ip} ${join_arg} $@
